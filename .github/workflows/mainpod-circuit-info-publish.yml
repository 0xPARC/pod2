---
name: Publish MainPod circuit info

on:
  # TODO: Uncomment before merging
  pull_request:
    branches: [ main ]
    types: [ready_for_review, opened, synchronize, reopened]
  push:
    branches: ["main"]

  # Allows to run this workflow manually from the Actions tab
  workflow_dispatch:

concurrency:
  group: wiki
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  wiki:
    name: Update MainPod circuit info to GitHub Wiki
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: ${{github.repository}}
          path: ${{github.repository}}

      - name: Checkout Wiki
        uses: actions/checkout@v4
        with:
          repository: ${{github.repository}}.wiki
          path: ${{github.repository}}.wiki

      - name: Push to wiki
        run: |
          set -e

          cd $GITHUB_WORKSPACE/${{github.repository}}
          table_entry=$(.github/workflows/scripts/circuit-info-table.sh)
          params=$(.github/workflows/scripts/mainpod-circuit-info.sh params)
          data=$(.github/workflows/scripts/mainpod-circuit-info.sh circuit-data)
          params_hash=$(echo "${data}" | jq .params_hash)

          cd $GITHUB_WORKSPACE/${{github.repository}}.wiki
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          echo "$params" > params/${params_hash}.json
          echo "$table_entry" >> MainPod-circuit-info.md
          git diff-index --quiet HEAD || git commit -m "action: update MainPod-circuit-info" && git push
